name: Build Kernel - ChromeOS ARCVM
on:
  push:
    branches: ["main", "ci", "checkci"]
  workflow_dispatch:

jobs:
  build:
    name: Build ChromeOS ARCVM kernel
    runs-on: self-hosted
    env:
      LTO: thin
      ROOT_DIR: /
      KERNEL_DIR: ${{ github.workspace }}/kernel
    steps:
      - name: Checkout KernelSU
        uses: actions/checkout@v4
        with:
          path: KernelSU
          fetch-depth: 0

      - name: Setup kernel source
        # FIXED: Using CURL to stream directly into the folder to save space and prevent URL errors
        run: |
          mkdir -p kernel
          curl -L "https://chromium.googlesource.com" | tar -xzC kernel

      - name: Setup KernelSU
        working-directory: kernel
        run: |
          echo "[+] KernelSU setup"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel
          ln -sf $GITHUB_WORKSPACE/KernelSU/kernel $KERNEL_ROOT/drivers/kernelsu
          DRIVER_MAKEFILE=$KERNEL_ROOT/drivers/Makefile
          grep -q "kernelsu" $DRIVER_MAKEFILE || echo "obj-y += kernelsu/" >> $DRIVER_MAKEFILE
          cd $KERNEL_ROOT && git apply $GITHUB_WORKSPACE/KernelSU/.github/patches/5.10/*.patch
          sed -i 's/-dirty//g' $KERNEL_ROOT/scripts/setlocalversion
          echo "kernelsu_version=10200" >> $GITHUB_ENV

      - name: Build Kernel
        working-directory: kernel
        run: |
          set -a && . build.config.gki.x86_64; set +a
          export DEFCONFIG=x86_64_arcvm_defconfig
          # Safety: Clean old mess and use -j1 to prevent Chromebook RAM crashes
          make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} mrproper
          make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} ${DEFCONFIG} < /dev/null
          scripts/config --file .config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
          make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} -j1 bzImage modules
          echo "file_path=${PWD}/arch/x86/boot/bzImage" >> $GITHUB_ENV

      - name: Upload kernel
        uses: actions/upload-artifact@v4
        with:
          name: kernel-ARCVM-x86_64
          path: "${{ env.file_path }}"
