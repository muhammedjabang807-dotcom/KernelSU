name: Build Kernel - ChromeOS ARCVM
on:
  push:
    branches: ["main", "ci", "checkci"]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        arch: [x86_64]
        version: ["5.10.178"]
        include:
          - arch: x86_64
            git_tag: chromeos-5.10-arcvm
    name: Build ChromeOS ARCVM kernel
    runs-on: self-hosted
    env:
      LTO: thin
      ROOT_DIR: /
      KERNEL_DIR: ${{ github.workspace }}/kernel
    steps:
      - name: Checkout KernelSU
        uses: actions/checkout@v4
        with:
          path: KernelSU
          fetch-depth: 0

      - name: Setup kernel source
        # FIXED URL: Added the full path to the kernel repository
        run: git clone https://chromium.googlesource.com -b ${{ matrix.git_tag }} --depth=1

      - name: Setup KernelSU
        working-directory: kernel
        run: |
          echo "[+] KernelSU setup"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel
          ln -sf $GITHUB_WORKSPACE/KernelSU/kernel $KERNEL_ROOT/drivers/kernelsu
          DRIVER_MAKEFILE=$KERNEL_ROOT/drivers/Makefile
          grep -q "kernelsu" $DRIVER_MAKEFILE || echo "obj-y += kernelsu/" >> $DRIVER_MAKEFILE
          cd $KERNEL_ROOT && git apply $GITHUB_WORKSPACE/KernelSU/.github/patches/5.10/*.patch
          sed -i 's/-dirty//g' $KERNEL_ROOT/scripts/setlocalversion
          VERSION=$(($(git rev-list --count HEAD) + 10200))
          echo "kernelsu_version=$VERSION" >> $GITHUB_ENV

      - name: Build Kernel
        working-directory: kernel
        run: |
          set -a && . build.config.gki.x86_64; set +a
          export DEFCONFIG=x86_64_arcvm_defconfig
          # FIXED: Using -j1 to prevent RAM-related crashes (Exit Code 2/137)
          make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} mrproper
          make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} ${DEFCONFIG} < /dev/null
          scripts/config --file .config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
          make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} -j1 bzImage modules
          echo "file_path=${PWD}/arch/x86/boot/bzImage" >> $GITHUB_ENV

      - name: Upload kernel-ARCVM-${{ matrix.arch }}-${{ matrix.version }}
        uses: actions/upload-artifact@v4
        with:
          name: kernel-ARCVM-${{ matrix.arch }}-${{ matrix.version }}
          path: "${{ env.file_path }}"
